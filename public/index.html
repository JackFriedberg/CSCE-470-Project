<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css?family=Bebas+Neue&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Bungee&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="style.css">

  <title>NBA Team Creation</title>
</head>

<body>
  <div class=contentContainer>
    <h1>NBA Team Creator</h1>
    <div id="team1Container">
      <h2 contenteditable="true" id="teamNameEdit">Team Name</h2> <!-- Editable title for the team -->
      <div>
        <div class="playerBoxEmpty" id="player1"><button class="playerAdd" onclick="openModal(this)">&#43;</button></div>
        <div class="playerBoxEmpty" id="player2"><button class="playerAdd" onclick="openModal(this)">&#43;</button></div>
        <div class="playerBoxEmpty" id="player3"><button class="playerAdd" onclick="openModal(this)">&#43;</button></div>
        <div class="playerBoxEmpty" id="player4"><button class="playerAdd" onclick="openModal(this)">&#43;</button></div>
        <div class="playerBoxEmpty" id="player5"><button class="playerAdd" onclick="openModal(this)">&#43;</button></div>
      </div>
    </div>

    <div id="team1Info" class = "teamInfo">
      <div id="team1Wins"   class= "teamTotals">Projected Wins Per 82 Game Season:</div>
      <div id="team1Points" class= "teamTotals">Projected Points Per Game:</div>
    </div>


    <div id="playerAddModal" class="modal">
      <div class="modal-content">
        <span class="close" id="modalCloser" onclick="closeModal()">&times;</span>
        <h2>Search for a Player</h2>
        <input type="text" name="searchText" id="searchText" placeholder="Lebron James">
        <div id="resultsDiv"></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script> <!-- Script for Socket IO API (FIXME when hosting somewhere new)-->
  <script>
    //socket io variable - talks front end to backend 
    var socket = io();
    var playerAddModal = document.getElementById('playerAddModal');
    var slotSelected = undefined; //keeps track of last-clicked player slot
    var team1Size = 0; //keeps track of how mnay players are currently selected



    //get the value inside the input box and send it to the backend
    function sendSearch() {
      var searchText = document.getElementById('searchText').value;
      console.log(searchText);
      if (searchText.replace(/\s/g, '').length > 1) {
        var searchString = '*' + searchText + '*';
        socket.emit('search', searchString);
      }
      else {
        clearSearchResults();
      }
    }

    //this function runs when backend passes Solr queries to the front end
    socket.on('sendResults', function (results) {
      //output search results in the console
      console.log("response: ", results.response);
      //get the documents returned
      allDocs = results.response.docs;
      //get the div to be updated with results
      var divToUpdate = document.getElementById("resultsDiv");
      //delete all prior results
      clearSearchResults();
      //for each document, make a new <P> element and store the entry id inside. Then append to the results div
      for (i = 0; i < allDocs.length; i++) {
        var responseString = allDocs[i].name + ' (' + allDocs[i].season + ')';
        var addButton = document.createElement("input");
        addButton.setAttribute('type', 'button');
        addButton.setAttribute('value', responseString);
        addButton.setAttribute('onclick', 'savePlayer(this)');
        addButton.setAttribute('data-stats', JSON.stringify(allDocs[i]));
        addButton.setAttribute('class', 'resultButton');
        divToUpdate.appendChild(addButton);
      }
    });


    //saves player from modal into the team
    function savePlayer(element) {
      var playerStats = element.getAttribute('data-stats');       //get the players info from the html element that was in the modal
      var currPlayer = JSON.parse(playerStats);                   //parse the stats into a JSON object
      var playerSlot = document.getElementById(slotSelected);     //get the slot that the player should go in
      playerSlot.removeChild(playerSlot.firstChild);              //remove the button in that slot
      playerSlot.setAttribute('class', 'playerBox')
      closeModal();

      // Create the the players portrait
      var playerImg = document.createElement("img");

      var imgPlayerName = currPlayer.name[0];
      console.log(imgPlayerName);
      imgPlayerName.replace(/\s/g, '');
      console.log(imgPlayerName);
      var imgPath = "images/" + imgPlayerName + ".png";
      console.log(imgPath);

      playerImg.setAttribute('src', imgPath);
      playerImg.setAttribute('class', 'cardImage');
      
      //Create the Player's Name and store stats
      var playerName = document.createElement("h3");
      playerName.innerHTML = currPlayer.name[0];
      playerName.setAttribute('class', 'cardName');
      playerName.setAttribute('data-stats', playerStats);
      playerName.setAttribute('id', slotSelected + 'Name');

      //create the div to hold the players stats
      var playerStats = document.createElement("div");

      //create the stats
      var playerPoints = document.createElement("p");
      playerPoints.setAttribute('style', 'margin:2px;');
      playerPoints.innerHTML = '<span style="font-weight: bold;">Points: </span><span id="' + slotSelected + 'oldPoints"></span><span style="font-weight: bold;"> &rArr; </span><span id="' + slotSelected + 'newPoints"></span>';

      var playerAssists = document.createElement("p");
      playerAssists.setAttribute('style', 'margin:2px;');
      playerAssists.innerHTML = '<span style="font-weight: bold;">Assists: </span><span id="' + slotSelected + 'oldAssists"></span><span style="font-weight: bold;"> &rArr; </span><span id="' + slotSelected + 'newAssists"></span>';

      var playerRebounds = document.createElement("p");
      playerRebounds.setAttribute('style', 'margin:2px;');
      playerRebounds.innerHTML = '<span style="font-weight: bold;">Rebounds: </span><span id="' + slotSelected + 'oldRebounds"></span><span style="font-weight: bold;"> &rArr; </span><span id="' + slotSelected + 'newRebounds"></span>';

      var playerUsage = document.createElement("p");
      playerUsage.setAttribute('style', 'margin:2px;');
      playerUsage.innerHTML = '<span style="font-weight: bold;">Usage Rate: </span><span id="' + slotSelected + 'oldUsage"></span><span style="font-weight: bold;"> &rArr; </span><span id="' + slotSelected + 'newUsage"></span>';

      //add the stats to the stat div
      playerStats.appendChild(playerPoints);
      playerStats.appendChild(playerAssists);
      playerStats.appendChild(playerRebounds);
      playerStats.appendChild(playerUsage);

      //create the delete button for the player card
      var deleteButton = document.createElement("span");
      deleteButton.setAttribute('class', 'close');
      deleteButton.setAttribute('onclick', 'deletePlayer(this)');
      deleteButton.innerHTML = "&times;";
   
      //add elements to card
      playerSlot.appendChild(deleteButton);
      playerSlot.appendChild(playerImg);
      playerSlot.appendChild(playerName);
      playerSlot.appendChild(playerStats);

      //increase the team size
      team1Size = team1Size + 1;
      //update the team stats
      updateTeamStats();
    }

    //removes a player from the team. Called from the X button on a player slot
    function deletePlayer(element) {
      //delete all the elements in the slot
      var parElement = element.parentElement;
      while (parElement.firstChild) {
        parElement.removeChild(parElement.firstChild);
      }

      // add back a button to the slot so we can add another player if we want 
      var addButton = document.createElement("button");
      addButton.innerHTML = '&#43;';
      addButton.setAttribute('class', 'playerAdd');
      addButton.setAttribute('onclick', 'openModal(this)');
      parElement.appendChild(addButton);
      parElement.setAttribute('class', 'playerBoxEmpty');

      //decrease the team size
      team1Size = team1Size - 1;
      //update the team stats
      updateTeamStats();
    }

    //called when player added/removed. Calculates wins/season and player stats on team
    function updateTeamStats() {

      var team1OldStats = {};
      var teamTotalUsg = 0;
      var team1Names = {};

      var team1OldUsg = {};
      var team1OldPPG = {};
      var team1OldAPG = {};
      var team1OldRPG = {};
      var team1OldWS = {};

      var team1NewUsg = {};
      var team1NewPPG = {};
      var team1NewAPG = {};
      var team1NewRPG = {};
      var team1NewWS = {};

      //get a players old stats
      for (i = 1; i < 6; i++) {
        if (document.getElementById('player' + i + 'Name')) { //means there's a player in this slot
          var playerStats = document.getElementById('player' + i + 'Name')
          team1OldStats[i - 1] = JSON.parse(playerStats.getAttribute('data-stats'));
          team1OldWS[i - 1] = team1OldStats[i - 1].ws_per_48;
          team1OldUsg[i - 1] = team1OldStats[i - 1].usg_pct;
          if (team1OldUsg[i - 1] == 0) {
            team1OldUsg[i - 1] = .1;
          }
          team1OldPPG[i - 1] = team1OldStats[i - 1].pts_per_g;
          team1OldAPG[i - 1] = team1OldStats[i - 1].ast_per_g[0];
          team1OldRPG[i - 1] = team1OldStats[i - 1].trb_per_g;
          team1Names[i - 1] = team1OldStats[i - 1].name;
        }
        else {
          team1OldStats[i - 1] = undefined;
          team1OldWS[i - 1] = 0;
          team1OldUsg[i - 1] = 0;
        }
        teamTotalUsg = teamTotalUsg + team1OldUsg[i - 1];
      }

      //calculate a player's new stats
      for (i = 0; i < 5; i++) {
        team1NewUsg[i] = round(team1OldUsg[i] / teamTotalUsg * 100, 1);
        team1NewPPG[i] = round(team1OldPPG[i] * team1NewUsg[i] / team1OldUsg[i], 1);
        team1NewAPG[i] = round(team1OldAPG[i] * team1NewUsg[i] / team1OldUsg[i], 1);
        team1NewRPG[i] = round(team1OldRPG[i] * team1NewUsg[i] / team1OldUsg[i], 1);
        team1NewWS[i] = round(team1OldWS[i] * team1NewUsg[i] / team1OldUsg[i], 1);
      }



      //iterate through players that are defined
      for (i = 0; i < 5; i++) {
        if (team1OldStats[i] != undefined) {
          var oldPoints = document.getElementById('player' + (i + 1) + 'oldPoints');
          var newPoints = document.getElementById('player' + (i + 1) + 'newPoints');
          var oldAssists = document.getElementById('player' + (i + 1) + 'oldAssists');
          var newAssists = document.getElementById('player' + (i + 1) + 'newAssists');
          var oldRebounds = document.getElementById('player' + (i + 1) + 'oldRebounds');
          var newRebounds = document.getElementById('player' + (i + 1) + 'newRebounds');
          var oldUsage = document.getElementById('player' + (i + 1) + 'oldUsage');
          var newUsage = document.getElementById('player' + (i + 1) + 'newUsage');

          
          oldPoints.innerHTML = team1OldPPG[i];
          newPoints.innerHTML = team1NewPPG[i];
          oldAssists .innerHTML = team1OldAPG[i];
          newAssists.innerHTML = team1NewAPG[i];
          oldRebounds.innerHTML = team1OldRPG[i];
          newRebounds.innerHTML = team1NewRPG[i];
          oldUsage.innerHTML = team1OldUsg[i];
          newUsage.innerHTML = team1NewUsg[i];
        }
      }

      if (team1Size == 5) { //if team is fully built, display projected wins and PPG
        var team1WinsPerGame = 0;
        var team1Points = 0;

        for (i = 0; i < 5; i++) { //add up PPG and WS of every player
          team1Points = team1Points + team1NewPPG[i];
          team1WinsPerGame = team1WinsPerGame + team1NewWS[i];
        }

        team1Points = team1Points + 30;               //adjusting for bench players
        var team1Wins = (team1WinsPerGame + .1) * 82; //win shares per game of starters, + .1 from non-starters, * 82 games is expected wins

        team1Wins = round(team1Wins, 0);      //round wins
        team1Points = round(team1Points, 0);  //round points

        document.getElementById('team1Wins').innerHTML = 'Projected Wins Per Season: ' + team1Wins; //display
        document.getElementById('team1Points').innerHTML = 'Projected Points Per Game: ' + team1Points; //display
      }
      else { //keep titles and stuff the same
        document.getElementById('team1Wins').innerHTML = 'Projected Wins Per Season:'; //display
        document.getElementById('team1Points').innerHTML = 'Projected Points Per Game:'; //display
      }
    }



    // --- Mostly helper functions and smaller display functions here on down ---- //

    function openModal(element) {
      playerAddModal.style.display = "inline-block";
      slotSelected = element.parentElement.id;
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
      if (event.target == playerAddModal) {
        closeModal();
      }
    }

    function closeModal() {
      playerAddModal.style.display = "none";
      clearSearchBox();
      clearSearchResults();
    }

    function debounce(fn, duration) {
      var timer;
      return function () {
        clearTimeout(timer);
        timer = setTimeout(fn, duration);
      }
    }

    searchText.addEventListener('keyup', debounce(() => {
      sendSearch();
    }, 500))

    //deletes previous search results from modal
    function clearSearchResults() {
      var divToUpdate = document.getElementById("resultsDiv");
      while (divToUpdate.firstChild) {
        divToUpdate.removeChild(divToUpdate.firstChild);
      }
    }

    //deletes text from the player search box
    function clearSearchBox() {
      document.getElementById('searchText').value = '';
    }

    //helper function to round stats off
    function round(value, decimals) {
      return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
    }


  </script>
</body>

</html>