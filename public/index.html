<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>NBA Team Creation</title>
  </head>
  
  <body>
    <div class = contentContainer> 
      <h1>NBA Team Creator</h1> 
      <div id="team1Container"> 
        <h2 contenteditable="true">Team Name</h3> <!-- Editable title for the team -->
          <div class="playerBox tooltip" id="player1"><button class="playerAdd" onclick="openModal(this)">&#43;</button></div>
          <div class="playerBox tooltip" id="player2"><button class="playerAdd" onclick="openModal(this)">&#43;</button></div>
          <div class="playerBox tooltip" id="player3"><button class="playerAdd" onclick="openModal(this)">&#43;</button></div>
          <div class="playerBox tooltip" id="player4"><button class="playerAdd" onclick="openModal(this)">&#43;</button></div>
          <div class="playerBox tooltip" id="player5"><button class="playerAdd" onclick="openModal(this)">&#43;</button></div>
      </div>

      <div id="team1StatContainer">
        <h2 id="team1InfoTitle"> Team Information - Complete your team to see how it would perform!</h2>
        <div id="team1Info">
          <h3 id="team1Wins"> Projected Wins Per Season: </h3>
          <h3 id="team1Points"> Projected Points Per Game: </h3>
        </div>
        <h2> Individual Player Performances </h2>
        <div id="newTeam1PlayerStats">
        </div>
      </div>

      <div id="playerAddModal" class="modal">
        <div class="modal-content">
          <span class="close" id="modalCloser" onclick="closeModal()">&times;</span>
          <h3>Search for a Player</h3>
          <input type="text" name="searchText" id="searchText">
          <div id = "resultsDiv"></div>
        </div>
      </div>
    </div>
   
    <script src="/socket.io/socket.io.js"></script> <!-- Script for Socket IO API (FIXME when hosting somewhere new)--> 
    <script>
      //socket io variable - talks front end to backend 
      var socket = io();
      var playerAddModal = document.getElementById('playerAddModal');
      var slotSelected = undefined;
      var team1Size = 0;

      function openModal(element){
        playerAddModal.style.display = "block";
        slotSelected = element.parentElement.id;
      }

      // When the user clicks anywhere outside of the modal, close it
      window.onclick = function(event) {
        if (event.target == playerAddModal) {
          closeModal();
        }
      }

      function closeModal(){
        playerAddModal.style.display = "none";
        clearSearchBox();
        clearSearchResults();
      }

      function debounce(fn, duration) {
        var timer;
        return function(){
          clearTimeout(timer);
          timer = setTimeout(fn, duration);
        }
      }

      searchText.addEventListener('keyup', debounce(() => {
        sendSearch();
      }, 500))

      //get the value inside the input box and send it to the backend
      function sendSearch(){
        var searchText = document.getElementById('searchText').value;
        if(searchText.replace(/\s/g, '').length > 1){
          var searchString = '*' + searchText + '*';
          socket.emit('search', searchString);  
        }
        else{
          clearSearchResults();
        }
      }

      function clearSearchResults(){
        var divToUpdate = document.getElementById("resultsDiv");
        //delete all prior results
        while (divToUpdate.firstChild) {
          divToUpdate.removeChild(divToUpdate.firstChild);
        }
      }

      function clearSearchBox(){
        document.getElementById('searchText').value = '';
      }

      //this function runs when backend passes Solr queries to the front end
      socket.on('sendResults', function(results){
        //output search results in the console
        console.log(results.response);
        //get the documents returned
        allDocs = results.response.docs;
        //get the div to be updated with results
        var divToUpdate = document.getElementById("resultsDiv");
        //delete all prior results
        clearSearchResults();
        //for each document, make a new <P> element and store the entry id inside. Then append to the results div
        for (i = 0; i < allDocs.length; i++){
          var responseString = allDocs[i].name + ' (' + allDocs[i].season + ')';
          var responseEntry = document.createElement("div");
          responseEntry.innerHTML = responseString;
          var addButton = document.createElement("input");
          addButton.setAttribute('type', 'button');
          addButton.setAttribute('value', 'add');
          addButton.setAttribute('onclick', 'savePlayer(this)');
          addButton.setAttribute('data-stats', JSON.stringify(allDocs[i]));
          responseEntry.appendChild(addButton);
          divToUpdate.appendChild(responseEntry);
        }
      });

      function savePlayer(element){
        var playerStats = element.getAttribute('data-stats');
        var currPlayer = JSON.parse(playerStats);
        var playerSlot = document.getElementById(slotSelected);
        playerSlot.removeChild(playerSlot.firstChild);
        closeModal();

        var playerName = document.createElement("p");
        playerName.innerHTML = currPlayer.name;
        playerName.setAttribute('class', 'playerName');
        playerName.setAttribute('data-stats', playerStats);

        var addButton = document.createElement("span");
        addButton.setAttribute('class', 'close');
        addButton.setAttribute('onclick', 'deletePlayer(this)');
        addButton.innerHTML = "&times;";
            
        var tooltipElement = document.createElement("span");
        tooltipElement.setAttribute('class', 'tooltiptext');
        tooltipText = 'Points/G: '+ currPlayer.pts_per_g + '\n' +
                      'Assists/G: '+ currPlayer.ast_per_g + '\n' +
                      'Rebounds/G: '+ currPlayer.trb_per_g + '\n';
        tooltipElement.innerHTML = tooltipText;            
            
        playerSlot.appendChild(addButton);
        playerSlot.appendChild(playerName);
        playerSlot.appendChild(tooltipElement);

        team1Size = team1Size + 1;
        updateTeamStats();
      }

      function deletePlayer(element){
        var parElement = element.parentElement;
        while (parElement.firstChild) {
          parElement.removeChild(parElement.firstChild);
        }

        var addButton = document.createElement("button");
        addButton.innerHTML = '&#43;';
        addButton.setAttribute('class', 'playerAdd');
        addButton.setAttribute('onclick', 'openModal(this)');
        parElement.appendChild(addButton);

        team1Size = team1Size - 1;
        updateTeamStats();
      }

      //called when player added/removed. Calculates wins/season and player stats on team
      function updateTeamStats() {
        if(team1Size == 5){
          //calculate wins/season
          team1Wins = 82;
          //calculate ppg
          team1Points = 150;
          document.getElementById('team1Wins').innerHTML = 'Projected Wins Per Season: ' + team1Wins;
          document.getElementById('team1Points').innerHTML = 'Projected Points Per Game: ' + team1Points;
        }
        
        //calculate individual stats for players
      }
    </script>
  </body>
</html>
